<html>
  <head>
    <title>My ParseApp site</title>
      <script src="http://www.parsecdn.com/js/parse-1.6.14.min.js"></script>
      <style>
          body > section{ display: none; }
          .active{ display: block; }
      </style>
  </head>
  <body>
      <section id="login-signup">
          <section id="signup">
          <h1>Signup</h1>
            <div>
                <label>Email</label>
                <input type="email">
            </div>
            <div>
                <label>Password</label>
                <input type="password">
            </div>
            <button id="signup-button" type="button">Sign up</button>
          </section>
          <section id="login">
      <h1>Login</h1>
       <div>
            <label>Email</label>
            <input type="email">
        </div>
        <div>
            <label>Password</label>
            <input type="password">
        </div>
        <button id="login-button" type="button">Login</button>
   </section>
      </section>
      <section id="main"> </section>
    
    
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script>
            Parse.initialize("trhHaGuuYNlb5Xh1tLPfala0t1TuW6LynFURnMR2", "dEUhUrIUbdSk89pnWAwb4zwhYx3LTxskmC82lPC7"); 
            
            moneyGuard = {};
            moneyGuard.expenses = {};
            
            // Check to see if logged in
            checkIfLoggedIn();
            function checkIfLoggedIn(){
                if( Parse.User.current() == null ){
                    $('#login-signup').addClass('active');       
                }else{
                    $('#main').addClass('active').siblings().removeClass('active');
                }
            }
            
            // Sign Up
            function signUp(username, password){
                var user = new Parse.User();
                user.set("username", username);
                user.set("password", password);
                user.set("email", username);

                user.signUp(null, {
                  success: function(user) {
                     alert("yay");
                  },
                  error: function(user, error) {
                    // Show the error message somewhere and let the user try again.
                    alert("Error: " + error.code + " " + error.message);
                  }
                })
            }
            
            // Log In
            function logIn(username, password){
                console.log(username, password);
                var user = new Parse.User();
                Parse.User.logIn(username, password, {
                    success: function(user) {
                        checkIfLoggedIn();
                    },
                    error: function(user, error) {
                        // The login failed. Check error to see why.
                    }
                });
            }

            var Categories = Parse.Object.extend("Categories");
            var categoriesQuery = new Parse.Query(Categories);
            
          
            // Get Session Token
            var user = new Parse.Object.extend("User");
            userQuery = new Parse.Query(user);
            userQuery.find({
              success: function(user){
                 console.log(user[0].getSessionToken())
              },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
                }
            });


            // Print out category list
            categoriesQuery.find({
              success: function(categories){
                  var categoryList = '';
                  for (var i = 0; i < categories.length; i++) {
                    categoryList += '<li id="' + categories[i].id + '"><button>+</button><span class="category">' + categories[i].get('Name') + '</span>';
                    categoryList += '<div class="week"><span class="spent">0</span><span>$' + Math.round(categories[i].get('Budget') / 4.3333333) + '</span></div>';
                    categoryList += '<div class="month"><span class="spent">0</span><span>$' + categories[i].get('Budget') + '</span></div>';
                    categoryList += '</li>';
                  }
                  $('#main').html('<ul id="expenses">' + categoryList + '</ul>');
              },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
                }
            });
       
            // Time Ranges
            var currentYear = new Date().getFullYear();
            var currentMonth = englishMonth(new Date().getMonth());
            var currentDayOfWeek = new Date().getDay();
            var currentMonthDateObj = new Date(currentMonth + ' 1, ' + currentYear + ' 00:00:00');

              
            // Expenses
            var expenses = Parse.Object.extend("Expenses");
            
            // Month
            var monthQuery = new Parse.Query(expenses);
            monthQuery.greaterThanOrEqualTo("Date", currentMonthDateObj);

            // Calculate monthly expenses
            monthQuery.find({
              success: function(expenses){
                objectifyExpenses(expenses, 'month');
              },
              error: function(error1) {
                alert("Error: " + error.code + " " + error.message);
                }   
            });
            
            // Week
            var weekQuery = new Parse.Query(expenses);
            weekQuery.greaterThanOrEqualTo("Date", getWeekStart());
            
            // Calculate weekly expenses
            weekQuery.find({
              success: function(expenses){
                objectifyExpenses(expenses, 'week');
                
              },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
                }   
            });
            
            
            // Events
            $(document).on('click', '#main button', function(){
                addExpense(2.22, 'kJdX3hg0Ze', new Date(), [34.1606659,-80.8805332]); 
            }).on('click', '#signup-button', function(){
               signUp($('#signup').find('[type=email]').val(), $('#signup').find('[type=password]').val()); 
            }).on('click', '#login-button', function(){
               logIn($('#login').find('[type=email]').val(), $('#login').find('[type=password]').val()); 
            });
            
            // FUNCTIONS
            function addExpense(amount, category, date, location){
                var Expenses = Parse.Object.extend("Expenses");
                var expenses = new Expenses();
                var category = new Parse.Object("Categories");
                category.id = "kJdX3hg0Ze";
                var geoPoint = new Parse.GeoPoint(location);
                expenses.save({
                    'Amount': 2.22,
                    'Date': new Date(),
                    'Category': category,
                    'Location': geoPoint
                });
            }
            
            function objectifyExpenses(expenses, timeRange){
                var expensesObj = {};
                var category;
                for (var i = 0; i < expenses.length; i++) {
                    category = expenses[i].get('Category').id;
                    expensesObj[category] = 0;      
                }
                for (var i = 0; i < expenses.length; i++) {
                    category = expenses[i].get('Category').id;
                    expensesObj[category] = expensesObj[category] + expenses[i].get('Amount');
                }
                moneyGuard.expenses[timeRange] = expensesObj;
                
                setTimeout(function(){
                    $('#expenses').find('li').each(function(){
                        categoryId = $(this).attr('id');
                        $(this).find('.' + timeRange).find('.spent').html(moneyGuard.expenses[timeRange][categoryId]);   
                    });
                    console.log(moneyGuard);
                }, 100, timeRange);
            }
            function getWeekStart() {
                var startOfWeek = 1;
                var currentDay = new Date().getDay();
                var timestamp = new Date().getTime();
                var daysAheadOfStart;
                var millisecondsAhead;
                
                if(currentDay >= startOfWeek){
                    daysAheadOfStart = currentDay - startOfWeek;
                }else{
                    daysAheadOfStart = 7 - (startOfWeek - currentDay);
                }
                    
                millisecondsAhead = daysAheadOfStart * (24 * 60 * 60 * 1000); 
                return new Date(new Date(timestamp - millisecondsAhead).setHours(0,0,0));
            }
            
            function englishMonth(monthNum){
                var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                return months[monthNum];
            }
            
            
        </script>
  </body>
</html>