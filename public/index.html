<html>
  <head>
    <title>MoneyGuard</title>
      <script src="http://www.parsecdn.com/js/parse-1.6.14.min.js"></script>
      <style>
          #top-bar{ background: black; }
          body > section{ display: none; }
          .active{ display: block; }
          .selected{ border: 3px solid red; }
          .other-days{ display: none; }
          .spent:before{ content: '$'; }
      </style>
  </head>
  <body>
      <div id="top-bar">
          <img src="http://placehold.it/30x30">
          <a href="#logout" class="name"></a>
          <a href="#settings" class="settings-button">Settings</a>
      </div>
      <section id="login-signup">
          <section id="signup">
          <h1>Signup</h1>
            <div>
                <label>Email</label>
                <input type="email">
            </div>
            <div>
                <label>Password</label>
                <input type="password">
            </div>
            <button id="signup-button" type="button">Sign up</button>
          </section>
          <section id="login">
      <h1>Login</h1>
       <div>
            <label>Email</label>
            <input type="email">
        </div>
        <div>
            <label>Password</label>
            <input type="password">
        </div>
        <button id="login-button" type="button">Login</button>
   </section>
      </section>
      <section id="main"> </section>
      <section id="add-expense" data-category="">
          <h1></h1>
          <div class="amount-input">$<input type="number"></div>
          <div class="button-group">
              <button type="button" class="selected">Today</button>
              <button type="button">Other</button>
          </div>
          <div class="button-group other-days">
              <button>M</button>
              <button>T</button>
              <button>W</button>
          </div>
          <textarea class="notes"></textarea>
          <hr>
          <button type="button" id="save-button">Record It</button>
      </section>
      <section id="settings"></section>
      
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script>
            Parse.initialize("trhHaGuuYNlb5Xh1tLPfala0t1TuW6LynFURnMR2", "dEUhUrIUbdSk89pnWAwb4zwhYx3LTxskmC82lPC7"); 
            
            moneyGuard = {};
            moneyGuard.expenses = {};
            moneyGuard.user = {};
            
            // Check to see if logged in
            checkIfLoggedIn();
            function checkIfLoggedIn(){
                if( Parse.User.current() == null ){
                    $('#login-signup').addClass('active');       
                }else{
                    var user = Parse.User.current();
                    console.log(user)
                    userQuery = new Parse.Query(user);
                    userQuery.equalTo('objectId', user.id);
                    userQuery.find({
                      success: function(user){
                          var name = user[0].get("name");
                          var friends = user[0].get("friends");
                          $('#top-bar').find('.name').html(name);
                          moneyGuard.user.name = name;
                          
                          // Get Friends List
                          var User = Parse.Object.extend("_User");
                            var user = new User();
                            var friendQuery = new Parse.Query(user);
                            friendQuery.containedIn('username', friends);
                            friendQuery.find(function(r){
                                console.log(r)
                                moneyGuard.user.friends = r;
                            });
                          moneyGuard.user.friends = friends;
                      },
                      error: function(error) {
                        alert("Error: " + error.code + " " + error.message);
                        }
                    });
                    $('#main').addClass('active').siblings().removeClass('active');
                }
            }
            
            // Sign Up
            function signUp(username, password){
                var user = new Parse.User();
                user.set("username", username);
                user.set("password", password);
                user.set("email", username);

                user.signUp(null, {
                  success: function(user) {
                     checkIfLoggedIn();
                  },
                  error: function(user, error) {
                    // Show the error message somewhere and let the user try again.
                    alert("Error: " + error.code + " " + error.message);
                  }
                })
            }
            
            // Log In
            function logIn(username, password){
                var user = new Parse.User();
                Parse.User.logIn(username, password, {
                    success: function(user) {
                        checkIfLoggedIn();
                    },
                    error: function(user, error) {
                        // The login failed. Check error to see why.
                    }
                });
            }

            var Categories = Parse.Object.extend("Categories");
            var categoriesQuery = new Parse.Query(Categories);
            
          
            


            // Print out category list
            categoriesQuery.find({
              success: function(categories){
                  var categoryList = '';
                  for (var i = 0; i < categories.length; i++) {
                    categoryList += '<li id="' + categories[i].id + '"><button>+</button><span class="category">' + categories[i].get('Name') + '</span>';
                    categoryList += '<div class="week"><span class="spent">0</span><span>$' + Math.round(categories[i].get('Budget') / 4.3333333) + '</span></div>';
                    categoryList += '<div class="month"><span class="spent">0</span><span>$' + categories[i].get('Budget') + '</span></div>';
                    categoryList += '</li>';
                  }
                  $('#main').html('<ul id="expenses">' + categoryList + '</ul>');
              },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
                }
            });
       
            // Time Ranges
            var currentYear = new Date().getFullYear();
            var currentMonth = englishMonth(new Date().getMonth());
            var currentDayOfWeek = new Date().getDay();
            var currentMonthDateObj = new Date(currentMonth + ' 1, ' + currentYear + ' 00:00:00');

              
            // Expenses
            var expenses = Parse.Object.extend("Expenses");
            
            // Month
            var monthQuery = new Parse.Query(expenses);
            monthQuery.greaterThanOrEqualTo("Date", currentMonthDateObj);

            // Calculate monthly expenses
            monthQuery.find({
              success: function(expenses){
                objectifyExpenses(expenses, 'month');
              },
              error: function(error1) {
                alert("Error: " + error.code + " " + error.message);
                }   
            });
            
            // Week
            var weekQuery = new Parse.Query(expenses);
            weekQuery.greaterThanOrEqualTo("Date", getWeekStart());
            
            // Calculate weekly expenses
            weekQuery.find({
              success: function(expenses){
                objectifyExpenses(expenses, 'week');
                
              },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
                }   
            });
            
            
            // Events
            $(document).on('click', '#signup-button', function(){
               signUp($('#signup').find('[type=email]').val(), $('#signup').find('[type=password]').val()); 
            }).on('click', '#login-button', function(){
               logIn($('#login').find('[type=email]').val(), $('#login').find('[type=password]').val()); 
            }).on('click', '#main button', function(){
                var categoryName = $(this).parents('li').find('.category').html();
                $('#add-expense').find('h1').html(categoryName);
                $('#add-expense').addClass('active').attr('data-category', $(this).parents('li').attr('id')); 
                $('#add-expense').find('.amount-input input').focus();
                getLocation();
            }).on('click', '#save-button', function(){
                var amount = $('#add-expense').find('.amount-input input').val()*1;
                if( amount <= 0 ){
                    alert('Something is wrong with your expense amount.');
                }else{
                    var latLong = $('#add-expense').attr('data-location').split(',');
                    addExpense(amount, $('#add-expense').attr('data-category'), new Date(), [latLong[0]*1, latLong[1]*1], $('#add-expense').find('.notes').val()); 
                }
            });
            
            
            
            // FUNCTIONS
            function addExpense(amount, cat, date, location, notes){
                var Expenses = Parse.Object.extend("Expenses");
                var expenses = new Expenses();
                var category = new Parse.Object("Categories");
                category.id = cat;
               // var User = new Parse.Object("_User");
                //User.id = moneyGuard.user.id;
                var geoPoint = new Parse.GeoPoint(location);
                
                // Set ACL
                var acl = new Parse.ACL();
                acl.setWriteAccess( Parse.User.current(), true);
                acl.setReadAccess( Parse.User.current(), true);
                for(i=0; i < moneyGuard.user.friends.length; i++){
                    console.log(moneyGuard.user.friends[i])
                    acl.setWriteAccess( moneyGuard.user.friends[i], true);
                    acl.setReadAccess( moneyGuard.user.friends[i], true);
                }
                
                acl.setPublicReadAccess(false);
                expenses.setACL(acl);
                
                expenses.save({
                    'Amount': amount,
                    'Date': date,
                    'Category': category,
                    'Location': geoPoint,
                    'Person': Parse.User.current(),
                    'Notes': notes
                }, {
                    success: function(expenses) {
                        $('#add-expense').removeClass('active');
                        incrementClientAmount(amount, cat);
                    },
                    error: function(expenses, error) {
                        console.log(error);
                    }
                });
            }
            function getLocation(){
                
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        $('#add-expense').attr('data-location', [position.coords.latitude, position.coords.longitude]);
                    });
                } else {
                    $('#add-expense').attr('data-location', [0,0]);
                }
            }
            function objectifyExpenses(expenses, timeRange){
                var expensesObj = {};
                var category;
                for (var i = 0; i < expenses.length; i++) {
                    category = expenses[i].get('Category').id;
                    expensesObj[category] = 0;      
                }
                for (var i = 0; i < expenses.length; i++) {
                    category = expenses[i].get('Category').id;
                    expensesObj[category] = expensesObj[category] + expenses[i].get('Amount');
                }
                moneyGuard.expenses[timeRange] = expensesObj;
                
                setTimeout(function(){
                    $('#expenses').find('li').each(function(){
                        categoryId = $(this).attr('id');
                        $(this).find('.' + timeRange).find('.spent').html(Math.round(moneyGuard.expenses[timeRange][categoryId]));   
                    });
                    console.log(moneyGuard);
                }, 100, timeRange);
            }
            function incrementClientAmount(amount, cat){
                console.log(amount, cat); 
                var monthCurrent = $('#' + cat).find('.month').find('.spent').html()*1;
                var weekCurrent = $('#' + cat).find('.week').find('.spent').html()*1;
                $('#' + cat).find('.month').find('.spent').html(Math.round(monthCurrent + amount));
                $('#' + cat).find('.week').find('.spent').html(Math.round(weekCurrent + amount));
            }
            function getWeekStart() {
                var startOfWeek = 1;
                var currentDay = new Date().getDay();
                var timestamp = new Date().getTime();
                var daysAheadOfStart;
                var millisecondsAhead;
                
                if(currentDay >= startOfWeek){
                    daysAheadOfStart = currentDay - startOfWeek;
                }else{
                    daysAheadOfStart = 7 - (startOfWeek - currentDay);
                }
                    
                millisecondsAhead = daysAheadOfStart * (24 * 60 * 60 * 1000); 
                return new Date(new Date(timestamp - millisecondsAhead).setHours(0,0,0));
            }
            
            function englishMonth(monthNum){
                var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                return months[monthNum];
            }
            
            
        </script>
  </body>
</html>