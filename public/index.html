<html>
  <head>
    <title>My ParseApp site</title>
      <script src="http://www.parsecdn.com/js/parse-1.6.14.min.js"></script>
  </head>
  <body>
    <ul class="categories"></ul>
    
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script>
            Parse.initialize("trhHaGuuYNlb5Xh1tLPfala0t1TuW6LynFURnMR2", "dEUhUrIUbdSk89pnWAwb4zwhYx3LTxskmC82lPC7"); 
            
            moneyGuard = {};
            moneyGuard.expenses = {};

            var Categories = Parse.Object.extend("Categories");
            var categoriesQuery = new Parse.Query(Categories);

            // Print out category list
            categoriesQuery.find({
              success: function(categories){
                  var categoryList = '';
                  for (var i = 0; i < categories.length; i++) {
                    categoryList += '<li id="' + categories[i].id + '"><button>+</button><span class="category">' + categories[i].get('Name') + '</span>';
                    categoryList += '<div class="week"><span class="spent">0</span><span>$' + Math.round(categories[i].get('Budget') / 4.3333333) + '</span></div>';
                    categoryList += '<div class="month"><span class="spent">0</span><span>$' + categories[i].get('Budget') + '</span></div>';
                    categoryList += '</li>';
                  }
                  $('body').html('<ul id="expenses">' + categoryList + '</ul>');
              },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
                }
            });
       
            // Time Ranges
            var currentYear = new Date().getFullYear();
            var currentMonth = englishMonth(new Date().getMonth());
            var currentDayOfWeek = new Date().getDay();
            var currentMonthDateObj = new Date(currentMonth + ' 1, ' + currentYear + ' 00:00:00');

              
            // Expenses
            var expenses = Parse.Object.extend("Expenses");
            
            // Month
            var monthQuery = new Parse.Query(expenses);
            monthQuery.greaterThanOrEqualTo("Date", currentMonthDateObj);

            // Calculate monthly expenses
            monthQuery.find({
              success: function(expenses){
                objectifyExpenses(expenses, 'month');
              },
              error: function(error1) {
                alert("Error: " + error.code + " " + error.message);
                }   
            });
            
            // Week
            var weekQuery = new Parse.Query(expenses);
            weekQuery.greaterThanOrEqualTo("Date", getWeekStart());
            
            // Calculate weekly expenses
            weekQuery.find({
              success: function(expenses){
                objectifyExpenses(expenses, 'week');
                
              },
              error: function(error) {
                alert("Error: " + error.code + " " + error.message);
                }   
            });
            
            
            // Events
            $(document).on('click', 'button', function(){
                addExpense(2.22, 'kJdX3hg0Ze', new Date(), [34.1606659,-80.8805332]); 
            });
            
            // FUNCTIONS
            function addExpense(amount, category, date, location){
                var Expenses = Parse.Object.extend("Expenses");
                var expenses = new Expenses();
                var category = new Parse.Object("Categories");
                category.id = "kJdX3hg0Ze";
                var geoPoint = new Parse.GeoPoint(location);
                expenses.save({
                    'Amount': 2.22,
                    'Date': new Date(),
                    'Category': category,
                    'Location': geoPoint
                });
            }
            
            function objectifyExpenses(expenses, timeRange){
                var expensesObj = {};
                var category;
                for (var i = 0; i < expenses.length; i++) {
                    category = expenses[i].get('Category').id;
                    expensesObj[category] = 0;      
                }
                for (var i = 0; i < expenses.length; i++) {
                    category = expenses[i].get('Category').id;
                    expensesObj[category] = expensesObj[category] + expenses[i].get('Amount');
                }
                moneyGuard.expenses[timeRange] = expensesObj;
                
                setTimeout(function(){
                    $('#expenses').find('li').each(function(){
                        categoryId = $(this).attr('id');
                        $(this).find('.' + timeRange).find('.spent').html(moneyGuard.expenses[timeRange][categoryId]);   
                    });
                    console.log(moneyGuard);
                }, 100, timeRange);
            }
            function getWeekStart() {
                var startOfWeek = 1;
                var currentDay = new Date().getDay();
                var timestamp = new Date().getTime();
                var daysAheadOfStart;
                var millisecondsAhead;
                
                if(currentDay >= startOfWeek){
                    daysAheadOfStart = currentDay - startOfWeek;
                }else{
                    daysAheadOfStart = 7 - (startOfWeek - currentDay);
                }
                    
                millisecondsAhead = daysAheadOfStart * (24 * 60 * 60 * 1000); 
                return new Date(new Date(timestamp - millisecondsAhead).setHours(0,0,0));
            }
            
            function englishMonth(monthNum){
                var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                return months[monthNum];
            }
            
            
        </script>
  </body>
</html>